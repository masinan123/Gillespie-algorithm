---
title: "The Gillespie Algorithm: Stochastic Modeling of Molecular Reaction Networks"
author: 
  - Jiayu Guo
  - Sinan Ma 
  - Anna Szydlowski
date: "`r Sys.Date()`"
output:
    number_sections: true
    citation_package: biblatex 
spacing: double
header-includes:
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead[L]{Title of Project}
  - \fancyfoot[CO,CE]{}
  - \fancyfoot[LE,RO]{\thepage}
  - \usepackage{setspace}\doublespacing
bibliography: references.bib 
editor_options: 
  markdown: 
    wrap: 72
---

\newpage 
\tableofcontents 
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\newpage

# Introduction

The Gillespie Algorithm was presented in 1976 by Daniel T. Gillespie (@Gillespie1976). This algorithm was developed  to answer the question, “If a fixed volume V contains a spatially uniform mixture of N chemical species which can inter-react through M specified chemical reaction channels, then given the numbers of molecules of each species present at some initial time, what will these molecular population levels be at any later time?” (@Gillespie1977). Given the trajectory of this molecular reaction is a stochastic process, this algorithm can simulate various molecular equation systems, such as radioactive decay models or decaying-dimerization reaction sets (@GillespieSSA).

In the following report, we will review basic concepts of the Gillespie Algorithm [Topic Review section](#sec-Topic-Review), then we will present the theory of the Gillespie Algorithm [Theory section](#sec-theory). Afterwards, we will demonstrate a stochastic simulation using the Gillespie algorithm of a dimerization reaction set [APplication section](#sec-application), using R(@citeR). Finally, we will provide our concluding remarks [Conclusion section](#sec-conclusion).


## background
In this report we studied the original version of the Gillespie algorithm.The Gillespie algorithm generates a statistically correct trajectory to simulate chemical or biochemical systems of reactions efficiently . It allows us to model dynamics that can’t be solved by the master equation analytically, especially for complicated examples.



## introduction
Biochemical reactions in cells are inherently stochastic :reactions can occur at any moment, and at any given time, the state of the system determines the probability of a particular chemical reaction occurring next. This is due to the random thermal motion of molecules and the small numbers of reactant molecules involved. When molecule counts are low (often dozens or hundreds rather than millions), random fluctuations in molecule collisions and interactions become significant, making the timing and order of reactions probabilistic rather than deterministic.

## theory
## Master Equation

Generally we use the distribution function $P(S,t)$ to describe a many particle system at time t, where $P(S,t)$ is the probability for the system to be in the state $S$ at time $t$. 

The equation governing the evolution of $P(S,t)$ is called the master equation. During the time interval $[t,t+dt)$, $P(S,t)$ is changed due to two types of process:

1. The particles in the state $S$ leave due to some reaction $S\rightarrow S'$.

2. The particles in other state $S'$ enter the state $S$ state due to some reaction $S'\rightarrow S$.

Combining the two factors, we obtain the master equation with the form $^{[1]}$ $$\frac{\partial}{\partial t}P(S,t)=\sum_{S'}P(S',t)R(S',S)-\sum_{S'}P(S,t)R(S,S')$$, where $R(S,S')$ represents the reaction rate from the state $S$ to the state $S'$.

The idea of master equation is inherently stochastic. Firstly $P(S,t)$ itself is a probabilistic description of the system. Next, in most of the cases, the reaction/process is stochastic. Therefore the master equation describes the ensemble average of all possible systems, here `ensemble` is the collection of all possible states with the same initial condition and macroscopic parameters. Following some certain initial distribution, we are not guaranteed to reach the same distribution at time $t$.

In the article `Cellular growth and division in the Gillespie algorithm` $^{[2]}$, the authors discussed the system of well-stirred mixture of $N$ chemical species. Since the system is well-stirred, the distribution of particles is always uniform in space. The state of the system can be described using a N-vector $Y=(X_1,...,X_N)$, where $X_i$ is the number of molecules of type $i$ in the system. Assume there are $\mu=1,...,M$ elementary reaction channels $R_{\mu}$. Let $c_{\mu}$ be the reaction rate, i.e., the probability that a random combination of molecules from channel $R_{\mu}$ selected at the moment $t$ react in the interval $[t,t+dt)$ with probability $c_{\mu}dt+o(dt)$. Let $h_{\mu}(Y)$ be the total number of possible distinct combinations of molecules for a channel $R_{\mu}$ when the system is in state $Y$, and $\alpha_{\mu}=(\alpha_{1,\mu},...,\alpha_{N,\mu})$ is a constant stoichiometric vector prescribing the change in the state of the system after the reaction $R_{\mu}$ has occurred.

For example, in a second order reaction $A+B\rightarrow AB$, we have $$\frac{d}{dt}X_{AB}=V\frac{d}{dt}[AB]=V*c'[A][B]=\frac{c'}{V}*X_AX_B=c*h(Y)$$, where $c'$ is the true reaction constant measured in chemistry, $V$ is the volume of the system and $[i]=\frac{X_i}{V}$ is the number concentration of species $i$.

With the above setting-up, The master equation for this system becomes $$\frac{\partial}{\partial t}P(Y,t|Y_0,t_0)=\sum_{\mu=1}^M c_{\mu}h_{\mu}(Y-\alpha_{\mu})P(Y-\alpha_{\mu},t|Y_0,t_0)-\sum_{\mu=1}^M c_{\mu}h_{\mu}(Y)P(Y,t|Y_0,t_0)$$, here $P(Y,t|Y_0,t_0)$ is the probability of the system being in state $Y$ at time $t$ given it is in state $Y_0$ at time $t_0$.

## Gillespie Algorithm

The master equation is a coupled linear ordinary equation for $|S_Y|$ dependent variables $P(Y,t|Y_0,t_0)$, where $|S_Y|$ is the size of the state space. For a system with $n$ particles, $|S_Y|$ is of order $O(n^N)$. Therefore it is almost impossible to solve the equation analytically, especially when the number of possible elementary reactions $M$ is large.

A practical alternative to solve the master equation is the stochastic simulation approach devised by Gillespie $^{[3]}$. Using the idea that $P(Y,t|Y_0,t_0)$ describes the ensemble average of all possible micro-states given initial state $Y_0$ at time $t_0$, the Gillespie algorithm generates an ensemble of sample trajectories of the system with statistics which asymptotically converges to the solution of the corresponding Master Equation. 

In the Gillespie algorithm, we update the state of the system by determining 

(i) the time $\tau$ to the next reaction

(ii) which reaction $R_{\mu}$ will occur next. 

Assuming that each reaction $R_{\mu}$ is independent with rate $a_{\mu}=h_{\mu}c_{\mu}$, the first occurrence $\tau_{\mu}$ of the reaction $R_{\mu}$ follows the exponential distribution with rate/propensity $a_{\mu}$. The first occurrence time of some reaction is then $\tau=\min_{\mu}\tau_{\mu}$, it follows  the exponential distribution with an overall rate/propensity $A=\sum_{\mu}a_{\mu}$. Given that a reaction occurs, the probability that it is the $\mu'$-th reaction is $P(\mu=\mu')=\frac{a_{\mu'}}{A}$. Therefore the the original Gillespie recipe follows the following steps:

1) Input values $c_{\mu}$, $\mu=1,...,M$ and initial state $Y_0=(x_1,...,x_N)$ at $t_0$.

2) Compute the current propensities $a_{\mu}=h_{\mu}(Y)c_{\mu}$, $\mu=1,...,M$ and $A=\sum_{\mu}a_{\mu}$

3) Generate uniform random numbers $u_1,u_2\in[0,1)$ 

4) Compute the time interval $\tau$ until the next reaction according to distribution $\exp(A)$, i.e., $\tau=-\ln u_1/A$

5) Find the channel of the next reaction $\mu$, i.e., take $\mu$ to be the integer for which $\sum_{\nu=1}^{\mu-1}a_{\nu}<u_2*A\le \sum_{\nu=1}^{\mu}a_{\nu}$

6) Update time $t\rightarrow t+\tau$, and adjust $Y$ in accordance with the particular reaction $R_{\mu}$, i.e., update $Y\rightarrow Y+a_{\mu}$, and proceed to step 2 until $t$ reaches presetting terminal time $T_f$ and obtain a final state $Y_f$ at $T_f$.


After generating sufficiently many $N_{Traj}$ such trajectories, we can estimate $P(Y,T_f|Y_0,t_0)=\frac{\# Y_{f,Traj}=Y }{N_{Traj}}$.

The Gillespie algorithm is straightforward and easy to implement. However, it is only an approximate rather than an exact stochastic algorithm. A very large number of trajectories is needed to reach a reasonable accuracy. The complexity of the algorithm is very high and the accuracy is not guaranteed due to randomness. 


# Topic Review {#sec-Topic-Review}

When you click the **Knit** button a document will be generated that
includes both content as well as the output of any embedded R code
chunks within the document. You can embed an R code chunk like this:

```{r cars,comment=NA}
summary(cars)
```

You can also embed publication quality plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

## Definitions and Examples

Such as importance of longitudinal data analysis (separate age and
cohort effect like in the effect of age on reading ability), different
correlation structures, missing data, etc.

## Details of the topic

This is a mathematical formua without formula number.
$$h(x) = \frac{f(x)}{S(x)} = -\frac{d \log[S(x])}{\rm dx}$$

This is how write a fomula and label it. \begin{align}
\label{eq2}
S(x) = \exp[-H(x)] = \exp[-\int_0^x h(u) {\rm d}u]
\end{align}

# Theory {#sec-theory}
# Application {#sec-application}
## Photodimerization Simulation
We can simulate the dimerization of DNA pyrimidines, a molecular reaction which can lead to skin cancer. Bipyrimidine photodimerization occurs when UV radiation alters the chemical bonds of two consecutive pyrimidine bases, with two possible outcomes: the formation of the cyclobutene pyrimidine dimer (CPD) if a cycloaddition between the C5-C6 double bond of the pyrimidines occurs, or the formation of pyrimidine (6-4) pyrimidone (64-PP) if  a covalent bond forms between C4 and C6 of the pyrimidines (@MartinezFernandez2022).

Therefore, this simulation involves 4 species and 3 reactions channels: pyrimidine monomers Thymine 1 (T1), Thymine 2 (T2), and dimer photoproducts CPD and 64-PP. 

We will simulate the dimerization of thymine using propensity based on the formation yield of CPD (~37 per 10^6 normal bases) and 64-PP (~2 per 10^6 normal bases) found by exposing skin cells to a UVB dose of 0.2 J/cm^2 (@Mouret2006). As the amount of thymine bases in DNA varies from person to person, we will simulate thymine photodimerization of 1000 pairs of thymine.

```{r simulation_1, echo=FALSE, warning=FALSE, message=FALSE}
# Load required libraries
if (!require("reshape2")) install.packages("reshape2")
if (!require("ggplot2")) install.packages("ggplot2")
library(reshape2)
library(ggplot2)
# Define reaction rates
c1 <- (1 - (37 + 2) / 1e6) * 10   # No dimerization occurs
c2 <- (37 / 1e6) * 10             # Formation of CPD
c3 <- (2 / 1e6) * 10              # Formation of 64-PP
# Initial state
state <- c(T1 = 10000, T2 = 10000, CPD = 0, `64PP` = 0)
# Define propensity functions
propensities <- function(state) {
  c(
    c1 * state["T2"],               # Reaction 1
    c2 * state["T1"] * state["T2"], # Reaction 2
    c3 * state["T2"]                # Reaction 3
  )
}
# Gillespie simulation function
simulate_gillespie <- function(state, max_time) {
  # Initialize time and output data frame
  time <- 0
  output <- data.frame(
    Time = numeric(0),
    T1 = numeric(0),
    T2 = numeric(0),
    CPD = numeric(0),
    `64PP` = numeric(0)
  )
  
  # Record the initial state
  initial_row <- c(Time = time, state)
  output <- rbind(output, as.data.frame(t(initial_row), stringsAsFactors = FALSE))
  
  while (time < max_time) {
    # Calculate propensities
    props <- propensities(state)
    total_prop <- sum(props)
    
    # Stop if no reactions can occur
    if (total_prop == 0) break
    
    # Time to next reaction
    delta_t <- rexp(1, rate = total_prop)
    time <- time + delta_t
    
    # Select which reaction occurs
    reaction <- sample(length(props), 1, prob = props)
    
    # Update state based on reaction
    if (reaction == 1) state["T2"] <- state["T2"] - 1
    if (reaction == 2) {
      state["T1"] <- state["T1"] - 1
      state["T2"] <- state["T2"] - 1
      state["CPD"] <- state["CPD"] + 1
    }
    if (reaction == 3) {
      state["T2"] <- state["T2"] - 1
      state["64PP"] <- state["64PP"] + 1
    }
    
    # Record the new state
    new_row <- c(Time = time, state)
    output <- rbind(output, as.data.frame(t(new_row), stringsAsFactors = FALSE))
  }
  
  # Convert columns to numeric for consistency
  output[] <- lapply(output, as.numeric)
  return(output)
}
# Run the simulation
max_time <- 100
simulation <- simulate_gillespie(state, max_time)
```

```{r graph_1, echo=FALSE, warning=FALSE, message=FALSE}
# Reshape data for plotting
simulation_long <- melt(simulation, id.vars = "Time")
# Plot results
ggplot(simulation_long, aes(x = Time, y = value, color = variable)) +
  geom_line() +
  labs(
    title = "Decay-Dimerization Reaction Set Simulation",
    x = "Time",
    y = "Molecule Count",
    color = "Species"
  ) +
  theme_minimal()
```

## Radioactive Decay Simulation

This simulation models the stochastic decay of a single species (\( R \)), which represents a radioactive substance such as radon, radium, or plutonium. The decay process is governed by the following reaction:

\[
R \xrightarrow{c} 0
\]

where \( c \) is the decay rate constant that defines the likelihood of decay per unit time.

The Gillespie algorithm is used to simulate this system, capturing the inherent randomness of radioactive decay events. Unlike deterministic approaches, the Gillespie algorithm tracks individual decay events over time, providing an accurate representation of the stochastic nature of the process. The goal of this simulation is to observe the time evolution of the remaining radioactive molecules (\( R \)) and visualize their decay over time.


```{r simulation_2, echo=FALSE, warning=FALSE, message=FALSE}
# Define parameters
c <- 0.01  # Decay rate constant
state <- c(R = 10000)  # Initial radioactive substance
max_time <- 1000  # Extended maximum simulation time

# Define propensity function
propensities <- function(state) {
  c * state["R"]
}

# Gillespie simulation function
simulate_gillespie <- function(state, max_time) {
  time <- 0
  output <- data.frame(Time = numeric(0), R = numeric(0))
  output <- rbind(output, data.frame(Time = time, R = state["R"]))
  
  while (time < max_time) {
    # Calculate propensity
    prop <- propensities(state)
    if (prop == 0) break  # Stop if no reactions can occur
    
    # Time to next reaction
    delta_t <- rexp(1, rate = prop)
    time <- time + delta_t
    
    # Update state (decay reaction)
    state["R"] <- state["R"] - 1
    
    # Record the state
    output <- rbind(output, data.frame(Time = time, R = state["R"]))
  }
  
  return(output)
}

# Run the simulation
simulation <- simulate_gillespie(state, max_time)

```

```{r decay-linear, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Radioactive Decay Simulation in Linear Scale"}

# Load ggplot2 for visualization
library(ggplot2)

# Linear-scale plot
ggplot(simulation, aes(x = Time, y = R)) +
  geom_line(color = "blue") +
  labs(
    x = "Time",
    y = "Remaining Radioactive Substance (R)"
  ) +
  theme_minimal()
```


```{r decay-log, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Radioactive Decay Simulation in Logarithmic Scale"}
# Logarithmic-scale plot
ggplot(simulation, aes(x = Time, y = R)) +
  geom_line(color = "red") +
  scale_y_log10() +
  labs(
    x = "Time",
    y = "Remaining Radioactive Substance (log(R))"
  ) +
  theme_minimal()

```

### Observations

The simulation results are visualized in two plots. Figure \@ref(fig:decay-linear) shows the decay on a linear scale, while Figure \@ref(fig:decay-log) presents the same data on a logarithmic scale to highlight the exponential nature of the decay process.

#### Exponential Decay
The radioactive substance (\( R \)) decays exponentially over time, as expected from the properties of radioactive decay. In Figure \@ref(fig-decay-linear), this behavior is reflected in the steep decline in \( R \) during the early stages of the simulation, followed by a more gradual decline as the remaining quantity of \( R \) decreases. This is consistent with the exponential decay law:

\[
R(t) = R_0 e^{-ct}
\]

where \( R_0 \) is the initial amount, \( c \) is the decay constant, and \( t \) is time. The propensity function \( a(R) = c \cdot R \) ensures that the decay rate is proportional to the remaining amount of \( R \).

In Figure \@ref(fig-decay-log), the decay trajectory appears as a straight line, which confirms the exponential nature of the process. The slope of this line corresponds to the decay constant \( c \), validating the theoretical prediction.

#### Stochastic Fluctuations
Unlike deterministic simulations, the stochastic approach introduces minor fluctuations in the timing of individual decay events. These fluctuations are more noticeable when the number of molecules is small, as random variations in the timing of events have a larger relative impact.

#### Time Steps and Decay Events
As the number of molecules decreases, the propensity \( a(R) \) becomes smaller, leading to larger intervals (\( \Delta t \)) between successive decay events. This dynamic is evident in both figures, where the rate of decline slows significantly in the later stages of the simulation.

### Biological and Physical Significance

#### Radioactive Half-Life
The exponential decay observed in this simulation aligns with the concept of half-life, the time required for half of the substance to decay. The half-life (\( t_{1/2} \)) can be computed as:

\[
t_{1/2} = \frac{\ln(2)}{c}
\]

For \( c = 0.01 \), the half-life is approximately \( t_{1/2} \approx 69.3 \) time units. This simulation demonstrates how the decay rate diminishes over time as the remaining radioactive substance depletes.

#### Real-World Applications
Radioactive decay is a fundamental process in nuclear physics, medicine, and environmental science. For example, it is critical in radiotherapy for cancer treatment, where the controlled decay of radioactive isotopes delivers targeted doses of radiation. It also has applications in monitoring environmental contaminants such as radon gas, where stochastic decay processes affect detection and measurement accuracy. Understanding the inherent randomness of decay is essential for accurate predictions, especially in low-count systems where stochastic effects dominate.


# Conclusion {#sec-conclusion}

# References
## Reference

[1]. N. G. V. Kampen, Stochastic Processes in Physics and Chemistry. North-Holland, Amsterdam, 1992.

[2]. T. Lu, D. Volfson, L. Tsimring, J. Hasty, Cellular growth and division in the Gillespie algorithm, Syst Biol (Stevenage). 2004 Jun;1(1):121-8


[3]. D. T. Gillespie, “Exact stochastic simulation of coupled chemical reactions,” J. Phys. Chem., vol. 81, no. 25, pp. 2340–2361,
1977.